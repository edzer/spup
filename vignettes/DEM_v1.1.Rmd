---
title: "Spatial uncertainty propagation analysis"
author: "Kasia Sawicka"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
subtitle: Case study with spatially variable standard deviation - slope calculations
  with a digital elevation model (DEM)
vignette: >
  %\VignetteIndexEntry{Spatial uncertainty propagation analysis}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r, echo = FALSE}
knitr::opts_chunk$set(
    comment = NA,
    quiet = TRUE,
    progress = FALSE,
    tidy = FALSE,
    cache = FALSE,
    message = FALSE,
    error = FALSE, # FALSE: always stop execution.
    warning = TRUE,
    dpi = 100
)
```

```{r, echo = FALSE}
knitr::opts_knit$set(global.par = TRUE)
```

```{r, echo = FALSE}
par(mar = c(3, 3, 2, 2), mgp = c(1.7, 0.5, 0), las = 1, cex.main = 1, tcl = -0.2, cex.axis = 0.8,
    cex.lab = 0.8)
```


### Introduction/Problem definition

In many geographical studies a DEM is a critical parameter, because the DEM-derived parameters such as slope, elevation, and aspect are of great importance in many types of analysis. However, the DEM is only an approximation of the real elevation in the area. It contains errors. Insight into the DEM error, uncertainty, and its propagation through the calculation of, for example, slope, is therefore crucial. We can use the Monte Carlo (MC) method to analyse how the error propagates through spatial operations and models. This method is briefly decribed below. 

The MC method is fairly straightforward in application, but in case of spatially distributed variables like DEM and slope one should consider taking spatial autocorrelation into account. That is because the model output may be influenced by the spatial correlation in the input. For example, slope calculations are quite sensitive to the degree of spatial autocorrelation in the DEM errors (Heuvelink, 1998). 

<br>

### Adapted MC methodology for the spatial uncertainty analysis with spatially variable sd

The adapted uncertainty propagation analysis approach is based on the Monte Carlo method that computes the output of the model repeatedly, with input values that are randomly sampled from their marginal or joint pdf. The set of model outputs forms a random sample from the output pdf, so that the parameters of the distribution, such as the mean, variance and quantiles, can be estimated from the sample. The method thus consists of the following steps:

1.	Characterise uncertain model inputs with pdfs.
1.	Repeatedly sample from (spatial) pdfs of uncertain inputs.
1.	Run model with sampled inputs and store model outputs.
1. 	Compute summary statistics of model outputs.

Note that the above ignores uncertainty in model parameters and model structure, but these can easily be included if available as probability distribution functions (pdfs). A random sample from the model inputs can be obtained using an appropriate pseudo-random number generator. 

For uncertain spatially distributed continuous variables, such as elevation, rainfall and soil organic carbon content, we assume the following geostatistical model:

	Z(x)= μ(x)+ σ(x)∙ε(x)

where μ is the (deterministic) mean of Z, σ is a possibly spatially variable standard deviation of the prediction of μ (spatial variation of σ reflects that in some parts of the study area the uncertainty is greater than in other parts), and ε is a normally distributed, standardized, zero-mean, spatially auto-correlated and second-order stationary residual modelled with a semivariogram or a correlogram. __The random sample is drawn from the pdf of ε to further calculate the realizations of Z.__ 

<br>

### DEM uncertainty propagation analysis with 'spup'

<br>

#### Preliminaries - load and view the data

Example data for slope calculations are 30m resolution mean DEM and standard deviation from the Zlatibor region in Serbia.

```{r, message = FALSE, warning = FALSE}
###########################################################################################################
# KS: I think here we should say how those maps been derived?

# GH: we should ask Tom Hengl or Branislav Bajat from Belgrade University. Is it not the SRTM DEM?

# KS: I think we know how they've been derived - from point interpolation (it's the same dataset as Damiano's). But we don't want to say it's point interpolation, becasue then we should use kriging for simulations.
###########################################################################################################
```

The 'DEM' dataset contains two spatial objects: a mean DEM of the area and the standard deviation. It also contains a function that calculates slope from DEM that will be used later.


```{r, fig.width = 5, fig.height = 3} 

# load packages
library(sp)
library(spup)

# load and view the data
data(DEM)
str(dem30m)
str(dem30m_sd)
spplot(dem30m, main = list(label = "Mean DEM", cex = 1))
summary(dem30m_sd)

```

<br>

#### Define uncertainty model (UM) for the DEM

The first step in uncertainty propagation analysis is to define uncertainty model for the uncertain input variable, here DEM, that will be used in further Monte Carlo sampling. 

In case of DEM, the ε(x) are spatially correlated and in order to include this in the analysis, we need to describe it by spatial correlogram parameters. The simple makecrm() function collates all necessary information into a list.

Let us assume that the spatial autocorrelation of the DEM errors is an exponentially decreasing function with a short-distance correlation of 0.8 and a range parameter of 300m.

```{r} 
###########################################################################################################
# KS: I think we need here to explain how we can estimate these?

# GH: Yes we do, but I think we can write "Let us assume that the spatial autocorrelation of the DEM errors is an exponentially decreasing function with a short-distance correlation of 0.78 and a range parameter of 321." Why did you choose these values? AHA I remember it is based on control point data. So we can either explain how we derived the correlogram ("geostatistical analysis of the DEM residuals derived from DEM elevations with ground truth observations at XXX locations in the study area.") If we skip this I suggest to use acf0=0.8 and range=300.

# KS: OK. I think we should just use the first sentence (I already added it above) and not mention control data - people will be asking wy didn't we just do kriging?
###########################################################################################################
```

```{r} 

# define spatial correlogram model
dem_crm <- makecrm(acf0 = 0.8, range = 300, model = "Exp")

```

```{r} 
###########################################################################################################
# Can we ask users to make a plot of the dem_crm and help them along with interpreting it by asking a few simple questions?

# KS: I don't think we should be asking them questions in a vignette unless we answer them. I think we can write though how they can interpret it. My attempt below.
###########################################################################################################
```

We can view the correlogram by plotting it.

```{r, fig.width = 5, fig.height = 3} 

plot(dem_crm, main = "DEM correlogram")

```

Spatial correlograms are great to examine patterns of spatial autocorrelation in your data or model residuals. They show how correlated are pairs of spatial observations when you increase the distance between them. In above case we can see how rapidly the correlation declines with distance, becasue we chose the exponential model. We can also see that it is positive for distance intervals less than 300m. You can manipulate the maximum of the correlation between two nearest points, the shape of the function and the maximum range. Try, for example, these combinations and see how they look like:

```{r, fig.width = 7, fig.height = 5} 

par(mfrow = c(2, 2))
crm <- makecrm(acf0 = 0.8, range = 700, model = "Sph") 
plot(crm, main = "'Spherical', acf0 = 0.8, range = 700")
crm <- makecrm(acf0 = 0.2, range = 700, model = "Sph") 
plot(crm, main = "'Spherical', acf0 = 0.2, range = 700")
crm <- makecrm(acf0 = 0.8, range = 700, model = "Lin") 
plot(crm, main = "'Linear', acf0 = 0.8, range = 700")
crm <- makecrm(acf0 = 0.8, range = 200, model = "Gau") 
plot(crm, main = "'Gausian', acf0 = 0.8, range = 200")

```


In order to complete the description of the uncertain variable we use the defineUM() function that collates all information about the DEM uncertainty into one object. The minimum information required is:

* the logical value that indicates if the object is uncertain (this allows an easy switch for possible analysis of contributions, see Vignette...XXX).
* the type of the distribution to sample from. In case of variables with spatially correlated errors only normal distribution is supported.
* the list of distribution parameters, for example a mean and a standard deviation (sd) for the normal distribution. In the case presented these are maps of the mean DEM and standard deviation of the DEM error. For details on supported distributions and required parameters see ?defineUM .
* correlogram model


```{r} 

# define uncertainty model for the DEM
demUM <- defineUMs(uncertain = TRUE, distribution = "norm", 
                   distr_param = c(dem30m, dem30m_sd), crm = dem_crm)

```

<br>

#### Generate possible realities of DEM

Generating possible realities of the DEM can be completed by using the genSample() function. The required information to pass to the function includes:

* defined uncertain object (as above).
* number of possible realizations to return.
* sampling method. In case of spatially correlated variable, the method "ugs" is reccomended, otherwise spatial correlation will not be taken into account. See ?genSample for more details.

Additional parameters may be also specified. For example, sampling of spatially correlated variable is based on the 'gstat' package that allows for limiting the number of nearest observations that should be used for the simulation.

Usually the sample must be large to obtain stable results. Let us run the sampling to obtain 100 realizations.

```{r, fig.width = 7, fig.height = 7} 

# create possible realizations of the DEM
dem_sample <- genSample(UMobject = demUM, n = 100, samplemethod = "ugs", nmax = 20)

# view several realizations of DEM 
spplot(dem_sample, c(1:6), main = list(label = "Examples of the DEM realizations", cex = 1))

```

We can veiw the mean and standard deviation of the sampled DEM:

```{r, fig.width = 5, fig.height = 3}

# compute and plot the slope sample statistics
# e.g. mean and standard deviation
dem_sample_mean <- mean(dem_sample)
dem_sample_sd <- sd(dem_sample)
dem_stats <- cbind(dem_sample_mean, dem_sample_sd)
spplot(dem_stats, main = list(label = "Mean and standard dev. of the DEM realizations", cex = 1))

```

The generated posible realizations of the DEM strongly depend on spatial auto-correlation. See for example how the Monte Carlo sample will look like if we assume less spatial-autocorrelation:

```{r, fig.width = 5, fig.height = 3} 

dem_crm2 <- makecrm(acf0 = 0.2, range = 300, model = "Exp")
demUM2 <- defineUMs(uncertain = TRUE, distribution = "norm", distr_param = c(dem30m, dem30m_sd), crm = dem_crm2)
dem_sample2 <- genSample(UMobject = demUM2, n = 100, samplemethod = "ugs", nmax = 20)
spplot(dem_sample, c(1), main = list(label = "dem_sample, acf0 = 0.8, range = 300m", cex = 1))
spplot(dem_sample2, c(1), main = list(label = "dem_sample2, acf0 = 0.2, range = 300m", cex = 1))

```

Can you spot the difference? Higher auto-correlation impose well-defined clusters. Lower values produce a more homogeneous spatial field.

```{r} 
###########################################################################################################
# KS :Or at least it should. Trouble is there is not that much difference becasue the epsilon is so small in comparison to the mean or sd DEM. I wonder if I do it correctly? Or in this specific case it will be like that?
###########################################################################################################
```

<br>

#### Uncertainty propagation through the model that calculates slope using DEM as input

In order to perform uncertainty propagation analysis using 'spup', the model through which uncertainty is propagated needs to be defined as an R function. The 'DEM' dataset includes an example of a pre-defined model that calculates slope using DEM as input. In this case the function is based on another existing R function for slope calculation. The 'spup' package also facilitates analysis with external models as long as they are callable from R (see Vignette XXX2 for an example).

```{r} 

# view the model
Slope

```

The propagation of uncertainty occurs when the model is run with an uncertain input. Running the model with a sample of realizations of uncertain variable(s) yields an equally large sample of possible model outputs that can be further analysed. To run the Slope model with the DEM realizations of DEM we use the propagate() function. The propagate() function takes as arguments:

* an output of genSample or a list of several outputs(???).
* the model as a function in R.
* the number of MC runs. This can be equal or smaller than the number of realizations of the uncertain input variable(s).

```{r} 

# run uncertainty propagation
slope_sample <- propagate1(dem_sample, model = Slope, n = 100)

```

<br>

#### Visualization of results

We can now view the sample of realizations of the slope calculations and visualize uncertainty by calculating and plotting the sample mean and standard deviation.


```{r, fig.width = 7, fig.height = 7} 

# view the sample of the model output
spplot(slope_sample[c(1:6)], main = list(label = "Examples of the slope realizations", cex = 1))

```

```{r, fig.width = 5, fig.height = 3}

# compute and plot the slope sample statistics
# e.g. mean and standard deviation
slope_mean <- mean(slope_sample)
slope_sd <- sd(slope_sample, na.rm = TRUE)
slope_stats <- cbind(slope_mean, slope_sd)
spplot(slope_stats, main = list(label = "Mean and standard dev. of slope realizations", cex = 1))

# check the histogram of slope at at some random locations
par(mfrow = c(2,2))
hist(as.numeric(slope_sample@data[1256,]), main = "Location A", xlab = "Slope")
hist(as.numeric(slope_sample@data[2000,]), main = "Location B", xlab = "Slope")
hist(as.numeric(slope_sample@data[5000,]), main = "Location C", xlab = "Slope")
hist(as.numeric(slope_sample@data[5781,]), main = "Location D", xlab = "Slope")

# or quantiles
slope_q <- quantile(slope_sample, probs = c(0.1, 0.25, 0.75, 0.9), na.rm = TRUE)
spplot(slope_q, mail = list(label = "Quantiles of slope realizations", cex = 1))

```

<br>

```{r} 
###########################################################################################################
# GH: Here I think we should ask users to interpret the visualised results. For example where are the highs and lows of the slope sd, is it the same as for DEM uncertainty (I expect not), check that quantile information agrees with sd, check the histogram of slope at a few locations (is it normal), etc. Perhaps invite them to repeat the analysis with a stronger or weaker spatial autocorrelation and compare results, etc. OK it should not become a computer practical but a bit of discussion and interpretation of of the results of the MC uncertainty propagation analysis is useful.

# KS: OK. I agree. I'll add the text subsequently, but can we first check if the calculations, especially of sd are OK? Becasue the sd calculated from the monte carlo sample both for the DEM and slope gets very low values. I just used standard R sd function to be applied row by row in a spatial grid data frame that is the Monte Carlo sample of DEM or slope. Additionally: what do you mean by 'agree' in "check that quantile information agrees with sd"?
###########################################################################################################
```



### Acknowledgements

The Zlatibor dataset was kindly provided by Prof. Branislav Bajat from the University of Belgrade, Serbia. 

This project has received funding from the European Union’s Seventh Framework Programme for research, technological development and demonstration under grant agreement no 607000.