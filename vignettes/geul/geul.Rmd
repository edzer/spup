---
title: "Spatial uncertainty propagation with Geul example"
author: "Kasia Sawicka"
date: "May 2016"
output:
  html_document:
    toc: true
    toc_depth: 3
---



```{r, echo=FALSE}
knitr::opts_chunk$set(
    comment = NA,
    quiet = TRUE,
    progress = FALSE,
    tidy = FALSE,
    cache = FALSE,
    message = FALSE,
    error = FALSE, # FALSE: always stop execution.
    warning = TRUE,
    dpi = 100
)
```


### Adapted (spatial) uncertainty propagation methodology

MC method is to compute the output of the model repeatedly, with input values that are randomly sampled from their marginal or joint pdf. The set of model outputs forms a random sample from the output pdf, so that the parameters of the distribution, such as the mean, variance and quantiles, can be estimated from the sample. The method thus consists of the following steps:

1.	Characterise uncertain model inputs with pdfs.
1.	Repeatedly sample from (spatial) pdfs of uncertain inputs.
1.	Run model with sampled inputs and store model outputs.
1. 	Compute summary statistics of model outputs.

Note that the above ignores uncertainty in model parameters and model structure, but these can easily be included if available as pdfs. A random sample from the model inputs can be obtained using an appropriate pseudo-random number generator. Note that a conditioning step will have to be included when the model inputs are correlated. 
Application of the MC method to uncertainty propagation with operations that involve spatial interactions requires the simultaneous generation of realisations from the spatially distributed inputs implying that spatial correlation will have to be accounted for. For uncertain spatially distributed continuous variables, such as elevation, rainfall and soil organic carbon content, we assume the following geostatistical model:

	Z(x)= μ(x)+ σ(x)∙ε(x)

where μ is the (deterministic)  mean of Z, σ is a spatially variable standard deviation of the prediction of μ (spatial variability of σ reflects that in some parts of study area the uncertainty is greater than in other parts), and ε is a standardized, zero-mean, spatially auto-correlated residual modelled with a semivariogram or a correlogram. The random sample is drawn from the pdf of ε to further calculate the realizations of Z. 


### Geul case description

For  the  general  assessment  of  health  risks  to  children  playing  in  the Geul valley, it could be sensible to make maps of potential daily lead ingestion.  This  can  be  done  if  it  is  known  how  much soil  a  child  is likely to ingest per day. Experimental data on the daily ingestion of soil by young children playing on a camping ground have shown that these fit  a  lognormal  distribution with  expected value  (i.e.  mean)  0.120,  median  0.052  and  standard  deviation  of 0.250 g/day. Maps of the potential daily ingestion of lead can now be obtained by multiplying the lead concentration of the soil by the amount of soil consumed. Uncertainty in both the lead concentration of the soil and the daily soil ingestion will propagate to the daily lead ingestion. This implies that even when a site is on average safe, there can be incidences in which the children’s health is at risk.

<br>

### Example code

```{r, message = FALSE, warning = TRUE} 

# Load packages, data and code
library(sp)
library(gstat)
source("makecrm.R")
source("crm2vgm.R")
source("ugs.R") # "ugs" = unconditional gaussian simulation
load("geul.RData")


# geul model
geulModel <- function(pb, sc) {
  ingestion <- pb 
  ingestion@data <- pb@data * sc
  ingestion
}


# number of Monte Carlo runs
MC <- 50


# simulate lead concentration maps
# correlogram for epsilon
lead_epsilon_crm <- makecrm(acf0 = 0.35, range = 20, model = "Exp")

set.seed(12345)
lead_sim <- ugs(n = MC, mean = geul_mean, sd = geul_sd, mask = geul_mask, crm = lead_epsilon_crm)
spplot(lead_sim[[1]], zcol = c("sim1", "sim3", "sim8", "sim15"), xlim=c(190200,191300), ylim=c(314300,315600),
        col.regions = bpy.colors())


# simulate soil consumption
m <- 0.12
s <- 0.250
scale <- sqrt(log(s**2/m**2 + 1))
locat <- log(m) -0.5 * scale^2

sc <- rlnorm(10000, locat, scale)
hist(sc, breaks = "Freedman-Diaconis", xlim=c(0, 2))


# Model run - calculate lead ingestion
ingest <- geulModel(pb = lead_sim[[1]][1], sc[1])
for (i in 1:(MC-1)) {
  ingest <- cbind(ingest, geulModel(pb = lead_sim[[1]][i+1], sc[i+1]))
}
### OK here is problem. It doesn't want to cbing SpatialGridData in a loop.

```


### Alternatively the geulModel could be just as (but then output doesn't contain information of spatiality):


```{r, message = FALSE, warning = FALSE} 

geulModel <- function(pb, sc) {
  pb * sc
}

# run it:
ingest <- numeric()
for (i in 1:MC) {
  ingest <- cbind(ingest, geulModel(pb = lead_sim[[1]][[i]], sc[i]))
}

```


### Further analysis we may want to do with this:

- calculate contributions of each uncertain variable to the total variance
- do various plots, e.g. adjacent maps of mean and sd of MC samples or model runs.

<br>
